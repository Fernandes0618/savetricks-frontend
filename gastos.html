<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="icon" type="image/png" href="icone.png" />
  <title>Gastos - SaveTricks</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');
    * { box-sizing: border-box; }
    body {
      margin: 0;
      background: #E8FCF1;
      font-family: 'Montserrat', sans-serif;
      color: #2C3E3A;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #58A69E;
    }
    .icon-dollar {
      font-weight: 900;
      font-size: 2.5rem;
      color: #3E726C;
      font-family: 'Courier New', Courier, monospace;
    }
    nav {
      background: #CFF3E3;
      border-radius: 12px;
      box-shadow: 0 0 12px #58A69E99;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      width: 100%;
      max-width: 800px;
      padding: 20px;
      margin-bottom: 35px;
    }
    a.menu-link {
      text-decoration: none;
      background: #58A69E;
      color: #E8FCF1;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      text-align: center;
      transition: background-color 0.3s;
    }
    a.menu-link:hover {
      background: #3E726C;
    }
    form, .summary, canvas, ul {
      background: #CFF3E3;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px #58A69E99;
      width: 100%;
      max-width: 400px;
      margin-bottom: 20px;
    }
    label {
      font-weight: 600;
      display: block;
      margin: 10px 0 5px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1.5px solid #58A69E;
      font-size: 1rem;
      background: #E8FCF1;
      outline-color: #58A69E;
    }
    button {
      margin-top: 20px;
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #58A69E;
      color: #E8FCF1;
      font-weight: 700;
      font-size: 1.1rem;
      cursor: pointer;
    }
    button:hover { background: #3E726C; }
    ul { list-style: none; padding: 0; }
    li { padding: 10px; border-bottom: 1px solid #ccc; }
    .summary { text-align: center; color: #2C3E3A; font-weight: 700; }
  </style>
</head>
<body>
  <header>
    <span class="icon-dollar">$</span>
    <h1>SaveTricks</h1>
  </header>

  <nav>
    <a href="home.html" class="menu-link">üè† Home</a>
    <a href="dicas.html" class="menu-link">üí° Dicas</a>
    <a href="gastos.html" class="menu-link">üìä Gastos</a>
    <a href="sobre.html" class="menu-link">üè¢ Sobre</a>
    <a href="bolsa.html" class="menu-link">üìà Bolsa</a>
  </nav>

  <form id="expense-form">
    <label>Valor:</label><input type="number" step="0.01" id="amount" required />
    <label>Categoria:</label>
    <select id="category" required>
      <option value="">Selecione</option>
      <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
      <option value="Transporte">Transporte</option>
      <option value="Moradia">Moradia</option>
      <option value="Lazer">Lazer</option>
      <option value="Sa√∫de">Sa√∫de</option>
      <option value="Educa√ß√£o">Educa√ß√£o</option>
      <option value="Outros">Outros</option>
    </select>
    <label>Data:</label><input type="date" id="date" required />
    <button type="submit">Adicionar gasto</button>
  </form>

  <div class="summary" id="total-summary">Total: R$ 0,00</div>
  <ul id="expense-list"></ul>
  <canvas id="category-chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const apiUrl = "https://savetricks-backend.onrender.com";
    const userId = localStorage.getItem("usuario_id");
    const list = document.getElementById("expense-list");
    const totalSummary = document.getElementById("total-summary");
    const chartCanvas = document.getElementById("category-chart");
    let chartInstance = null;

    document.getElementById("expense-form").addEventListener("submit", function(e) {
      e.preventDefault();
      const amount = parseFloat(document.getElementById("amount").value);
      const category = document.getElementById("category").value;
      const date = document.getElementById("date").value;

      fetch(apiUrl + "/api/gastos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ usuario_id: userId, valor: amount, categoria: category, data: date })
      }).then(() => loadExpenses());
    });

    function loadExpenses() {
      fetch(apiUrl + "/api/gastos/" + userId)
        .then(res => res.json())
        .then(data => {
          list.innerHTML = "";
          let total = 0;
          const categoryTotals = {};

          data.forEach(exp => {
            total += exp.valor;
            categoryTotals[exp.categoria] = (categoryTotals[exp.categoria] || 0) + exp.valor;

            const item = document.createElement("li");
            item.textContent = `R$ ${exp.valor.toFixed(2)} - ${exp.categoria} - ${exp.data}`;
            list.appendChild(item);
          });

          totalSummary.textContent = `Total: R$ ${total.toFixed(2).replace(".", ",")}`;
          renderChart(categoryTotals);
        });
    }

    function renderChart(categoryTotals) {
      const labels = Object.keys(categoryTotals);
      const data = Object.values(categoryTotals);

      if (chartInstance) chartInstance.destroy();
      chartCanvas.style.display = labels.length ? 'block' : 'none';

      if (labels.length === 0) return;

      chartInstance = new Chart(chartCanvas, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: [
              '#58A69E','#7FC1B8','#A7D3C6','#3E726C',
              '#91BCB7','#2F5D57','#BBD9D1'
            ]
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return context.label + ': R$ ' + context.parsed.toFixed(2);
                }
              }
            }
          }
        }
      });
    }

    loadExpenses();
  </script>
</body>
</html>